<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Update Password | Ullr Systems</title>
  <link rel="stylesheet" href="mainmenu.css">
</head>
<body>
  <!-- Header -->
  <header class="header-bar">
    <h1 class="brand">
      <span class="ullr">Ullr</span> <span class="systems">Systems</span>
    </h1>
  </header>

  <!-- Layout Container -->
  <div class="layout-container">
    <!-- Sidebar -->
<aside class="sidebar">
  <nav class="main-menu">
    <ul>
      <li><a href="MainMenu.html">Inventory</a></li>
      <li><a href="Order.html">Order</a></li>
      <li><a href="Alerts.html">Alerts</a></li>
      <li><a href="#" id="manageAccountsLink">Manage Accounts</a></li>
      <li><a href="#" id="manageFridgesLink">Manage Fridges</a></li>
      <li><a href="#" id="reportsLink">Reports</a></li>
      <li><a href="#" id="createAccountLink">Create Account</a></li>
       <li><a href="#" id="logoutLink">Logout</a></li>
    </ul>
  </nav>
</aside>


    <!-- Main Content -->
    <main class="content-area">
      <h2>Update Password</h2>
      <form id="updatePasswordForm" method="POST" action="updatePassword" class="update-form">
        <div class="form-group">
          <label for="username">Select User:</label>
          <select id="username" name="username" class="form-select">
            <!-- Populated by JS -->
          </select>
        </div>

        <div class="form-group">
          <label for="password">New Password:</label>
          <input type="password" id="password" name="password" class="form-input" required>
        </div>

        <div class="form-group">
          <label for="repeatPassword">Confirm Password:</label>
          <input type="password" id="repeatPassword" name="repeatPassword" class="form-input" required>
        </div>

        <button type="submit" class="btn btn-success">Update Password</button>
      </form>
      <div id="message" class="message"></div>
    </main>
  </div>

  <script>
    // Load user list for the drop-down
    async function loadUserList() {
      try {
        const response = await fetch('/UllrSystems/getAllUsers');
        if (!response.ok) {
          throw new Error('Failed to fetch user list');
        }
        const data = await response.json();
        const userSelect = document.getElementById('username');

        userSelect.innerHTML = '';
        data.users.forEach(u => {
          const option = document.createElement('option');
          option.value = u;
          option.textContent = u;
          userSelect.appendChild(option);
        });
      } catch (error) {
        console.error(error);
        const messageDiv = document.getElementById('message');
        messageDiv.textContent = 'Error loading users';
        messageDiv.classList.add('error');
      }
    }

    // Handle form submission
    document.getElementById('updatePasswordForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const form = this;
      const username = form.username.value;
      const password = form.password.value;
      const repeatPassword = form.repeatPassword.value;

      // Check if passwords match on client-side before sending
      if (password !== repeatPassword) {
        const messageDiv = document.getElementById('message');
        messageDiv.classList.remove('success');
        messageDiv.classList.add('error');
        messageDiv.textContent = 'Passwords do not match. Please re-enter.';
        return;
      }

      const urlEncodedData = new URLSearchParams();
      urlEncodedData.append('username', username);
      urlEncodedData.append('password', password);
      urlEncodedData.append('repeatPassword', repeatPassword);

      try {
        const response = await fetch('/UllrSystems/updatePassword', {
          method: 'POST',
          body: urlEncodedData,
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          }
        });

        if (!response.ok) {
          throw new Error('Failed to update password.');
        }

        const result = await response.json();
        const messageDiv = document.getElementById('message');

        if (result.success) {
          messageDiv.classList.remove('error');
          messageDiv.classList.add('success');
          messageDiv.textContent = result.message;
          form.reset();
        } else {
          messageDiv.classList.remove('success');
          messageDiv.classList.add('error');
          messageDiv.textContent = result.message;
        }
      } catch (error) {
        console.error(error);
        const messageDiv = document.getElementById('message');
        messageDiv.classList.remove('success');
        messageDiv.classList.add('error');
        messageDiv.textContent = 'Error updating password.';
      }
    });

    // On page load
    window.addEventListener('DOMContentLoaded', loadUserList);
  </script>
  <!-- Add the script BELOW so it sees your IDs -->
  <script src="roleCheck.js"></script>
  <script src="logout.js"></script>
</body>
</html>


